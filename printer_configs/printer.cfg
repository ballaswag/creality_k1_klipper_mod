# K1
# Printer_size: 220x220x250
# Version: v1.0.25
# CreateDate: 2023/03/21
# Nozzle_mcu: chip: GD32F303CBT6
#             version: CR-K1-MAX-NOZZLE-V1.0.0
# Leveling_mcu: chip: GD32E230F8P6
#             version: CR-K1-MAX-LEVELING-V1.0.0
# mcu: chip: GD32F303RET6
#      version: CR4CU220812S12

[include GuppyScreen/*.cfg]
[include sensorless.cfg]
[include custom_gcode.cfg]
[include fluidd.cfg]
[include fan_control.cfg]
[include timelapse.cfg]

[mcu]
serial: /dev/ttyS7
baud: 230400
restart_method: command

[mcu nozzle_mcu]
serial: /dev/ttyS1
baud: 230400
restart_method: command

#[mcu leveling_mcu]
#serial: /dev/ttyS9
#baud: 230400
#restart_method: command

[verify_heater extruder]

[verify_heater heater_bed]
check_gain_time: 120
heating_gain: 1.0
hysteresis: 10

[mcu rpi]
serial: /tmp/klipper_host_mcu

#[bl24c16f]
#i2c_mcu: rpi
#i2c_bus: i2c.2
#i2c_speed: 400000

[idle_timeout]
timeout: 99999999

[virtual_sdcard]
path: /usr/data/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

[gcode_arcs]
resolution: 1.0

[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

[temperature_sensor chamber_temp]
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 125

[duplicate_pin_override]
pins: PC0, PC5

[temperature_fan chamber_fan]
pin: PC0
cycle_time: 0.0100
hardware_pwm: false
max_power: 1
shutdown_speed: 0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
min_temp: 0
max_temp: 70
control: watermark
max_delta: 2
target_temp: 35.0
max_speed: 1.0
min_speed: 0.0

[stepper_x]
step_pin: PC2
dir_pin: !PB9
enable_pin: !PC3
microsteps: 32
rotation_distance: 72
endstop_pin: tmc2209_stepper_x:virtual_endstop
position_endstop: 229
position_min: -8
position_max: 229
homing_speed: 36
homing_retract_dist:0

[tmc2209 stepper_x]
uart_pin:PA9
interpolate: False
run_current:1.5
hold_current:1.0
sense_resistor: 0.100
stealthchop_threshold: 0
uart_address:3
diag_pin: ^PB12
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 1
# driver_TOFF: 1
# driver_HEND: 0
# driver_HSTRT: 7
driver_SGTHRS: 65

[stepper_y]
step_pin: PB8
dir_pin: !PB7
enable_pin: !PC3
microsteps: 32
rotation_distance: 72
endstop_pin: tmc2209_stepper_y:virtual_endstop
position_endstop: -3
position_min: -3
position_max: 215
homing_speed: 36
homing_retract_dist:0

[tmc2209 stepper_y]
uart_pin:PA10
interpolate: False
run_current:1.5
hold_current:1.0
sense_resistor: 0.100
stealthchop_threshold: 0
uart_address:3
diag_pin: ^PB13
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 1
# driver_TOFF: 1
# driver_HEND: 0
# driver_HSTRT: 7
driver_SGTHRS: 65

[stepper_z]
step_pin: PB6
dir_pin: !PB5
enable_pin: !PC3
microsteps: 16
rotation_distance:8
gear_ratio: 64:20
# endstop_pin: tmc2209_stepper_z:virtual_endstop# PA15   #probe:z_virtual_endstop
# position_endstop: 0
endstop_pin: probe:z_virtual_endstop
position_max: 255
position_min: -5

[tmc2209 stepper_z]
uart_pin: PA11
uart_address: 3
run_current: 0.8
diag_pin: ^PB14
stealthchop_threshold: 0
sense_resistor: 0.100
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 1
# driver_TOFF: 1
# driver_HEND: 2
# driver_HSTRT: 2
driver_SGTHRS: 0

[extruder]
max_extrude_only_distance: 1000.0
max_extrude_cross_section: 80
step_pin: nozzle_mcu:PB1
dir_pin: nozzle_mcu:PB0
enable_pin: !nozzle_mcu:PB2
microsteps: 16
rotation_distance: 6.9
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: nozzle_mcu:PB7
sensor_type: EPCOS 100K B57560G104F
sensor_pin: nozzle_mcu:PA0
pressure_advance: 0.04
pressure_advance_smooth_time: 0.040
control: pid
pid_Kp: 25.013
pid_Ki: 2.566
pid_Kd: 60.966
min_temp: 0
max_temp: 320

[tmc2209 extruder]
uart_pin: nozzle_mcu:PB11
tx_pin: nozzle_mcu:PB10
uart_address: 3
run_current: 0.55
sense_resistor: 0.150
stealthchop_threshold: 0
# driver_IHOLDDELAY: 8
# driver_TPOWERDOWN: 20
# driver_TBL: 2
# driver_TOFF: 3
# driver_HEND: 0
# driver_HSTRT: 5

[heater_bed]
heater_pin: PB10
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
#control: watermark
# control: pid
# pid_kp: 27
# pid_ki: 0.08
# pid_kd: 0
min_temp: 0
max_temp: 115

[filament_switch_sensor filament_sensor]
pause_on_runout: true
switch_pin: !PC15
runout_gcode:
  {% if printer.extruder.can_extrude|lower == 'true' %}
    G91
    G0 E30 F600
    G90
  {% endif %}

#[filament_switch_sensor filament_sensor_2]
#pause_on_runout: true
#switch_pin: !nozzle_mcu:PA10

[multi_pin heater_fans]
pins:nozzle_mcu:PB5,PB2

[heater_fan hotend_fan]
pin: multi_pin:heater_fans
heater: extruder
heater_temp: 40

[static_digital_output my_fan_output_pins]
pins: nozzle_mcu: PB6

# hotend fan
[output_pin fan0]
pin: !nozzle_mcu: PB8
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.00
scale: 255
shutdown_value: 0.0

# chamber fan
[output_pin fan1]
pin: PC0
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.00
scale: 255
shutdown_value: 0.0

# auxiliary fan
[output_pin fan2]
pin: PB1
pwm: True
cycle_time: 0.0100
hardware_pwm: false
value: 0.00
scale: 255
shutdown_value: 0.0

[output_pin LED]
pin:PB0
pwm: True
cycle_time: 0.010
value: 1

[adxl345]
cs_pin: nozzle_mcu:PA4
spi_speed: 5000000
axes_map: x,-z,y
spi_software_sclk_pin: nozzle_mcu:PA5
spi_software_mosi_pin: nozzle_mcu:PA7
spi_software_miso_pin: nozzle_mcu:PA6

[resonance_tester]
accel_chip: adxl345
accel_per_hz: 75
# min_freq: 30
# max_freq: 100
probe_points:
   110,110,10

[display_status]

[exclude_object]

[printer]
kinematics: corexy
max_velocity: 800
max_accel: 20000
#max_accel_to_decel: 20000
max_z_velocity: 20
square_corner_velocity: 5.0
#square_corner_max_velocity: 200.0
max_z_accel: 300

[pause_resume]
# recover_velocity: 500.

# [force_move]
# # Enable commands that force potentially unsafe movement
# enable_force_move: True

# [gcode_macro UNSAFE_LOWER_BED]
# description: Lower the bed 10mm without homing
# gcode:
#   G90
#   SET_KINEMATIC_POSITION Z=0
#   G0 Z-10 F600
#   M84
  
### btt eddy
[mcu eddy]
serial: /dev/serial/by-id/usb-Klipper_rp2040_45503571288CBAF8-if00

[temperature_sensor btt_eddy_mcu]
sensor_type: temperature_mcu
sensor_mcu: eddy
min_temp: 10
max_temp: 100

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
z_offset: 1.0
#i2c_address:
i2c_mcu: eddy
i2c_bus: i2c0f
x_offset: -38.5 # Set according to the actual offset relative to the nozzle
y_offset: 11.8 # Set according to the actual offset relative to the nozzle
data_rate: 500

[temperature_probe btt_eddy]
sensor_type: Generic 3950
sensor_pin: eddy:gpio26
horizontal_move_z: 2

[bed_mesh]
horizontal_move_z: 2
speed: 300
mesh_min: 0, 20
mesh_max: 185, 215
probe_count: 20, 20
algorithm: bicubic

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 66.7
#*# shaper_type_y = zv
#*# shaper_freq_y = 55.5
#*#
#*# [extruder]
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 63.189
#*# pid_ki = 0.747
#*# pid_kd = 1336.451
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3191485.859,0.100000:3190580.443,0.150000:3189723.550,
#*# 	0.200000:3188853.263,0.250000:3187972.733,0.300000:3187177.021,
#*# 	0.350000:3186349.228,0.400000:3185565.300,0.450000:3184790.736,
#*# 	0.500000:3184032.672,0.550000:3183290.229,0.600000:3182627.298,
#*# 	0.650000:3181850.207,0.700000:3181217.016,0.750000:3180568.398,
#*# 	0.800000:3179886.199,0.850000:3179250.787,0.900000:3178659.179,
#*# 	0.950000:3178038.044,1.000000:3177413.381,1.050000:3176835.014,
#*# 	1.100000:3176273.094,1.150000:3175696.886,1.200000:3175145.865,
#*# 	1.250000:3174581.772,1.300000:3174130.943,1.350000:3173576.220,
#*# 	1.400000:3173055.574,1.450000:3172573.512,1.500000:3172093.062,
#*# 	1.550000:3171608.626,1.600000:3171156.987,1.650000:3170712.845,
#*# 	1.700000:3170262.474,1.750000:3169844.965,1.800000:3169380.410,
#*# 	1.850000:3169033.008,1.900000:3168595.144,1.950000:3168182.391,
#*# 	2.000000:3167801.701,2.050000:3167417.076,2.100000:3167048.134,
#*# 	2.150000:3166689.202,2.200000:3166324.246,2.250000:3165971.280,
#*# 	2.300000:3165670.683,2.350000:3165289.034,2.400000:3164970.273,
#*# 	2.450000:3164636.484,2.500000:3164331.056,2.550000:3164029.017,
#*# 	2.600000:3163727.054,2.650000:3163464.504,2.700000:3163136.650,
#*# 	2.750000:3162878.422,2.800000:3162587.249,2.850000:3162324.115,
#*# 	2.900000:3162095.285,2.950000:3161784.473,3.000000:3161532.329,
#*# 	3.050000:3161289.278,3.100000:3161059.564,3.150000:3160857.067,
#*# 	3.200000:3160593.376,3.250000:3160357.602,3.300000:3160136.599,
#*# 	3.350000:3159936.094,3.400000:3159685.337,3.450000:3159500.288,
#*# 	3.500000:3159269.831,3.550000:3159058.492,3.600000:3158869.375,
#*# 	3.650000:3158645.839,3.700000:3158468.828,3.750000:3158295.110,
#*# 	3.800000:3158098.076,3.850000:3157920.867,3.900000:3157729.490,
#*# 	3.950000:3157568.766,4.000000:3157389.950,4.050000:3157126.399
#*# calibration_temp = 33.939515
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.155211, 0.322522, 0.099590, -0.203764, -0.228339, -0.249936, -0.278434, -0.305658, -0.331095, -0.359865, -0.384008, -0.401354, -0.422332, -0.448047, -0.467483, -0.494384, -0.504941, -0.525106, -0.538679, -0.552121
#*# 	0.162666, 0.326392, 0.280902, 0.245035, 0.212287, 0.180569, 0.147948, 0.119504, 0.086537, 0.055918, 0.033486, 0.009102, -0.020247, -0.050849, -0.073637, -0.094103, -0.108354, -0.128878, -0.147784, -0.164804
#*# 	0.155211, 0.328142, 0.290875, 0.261692, 0.234425, 0.204517, 0.173843, 0.141147, 0.107193, 0.072452, 0.048315, 0.021876, -0.005821, -0.035657, -0.067934, -0.095726, -0.115269, -0.140231, -0.158213, -0.173471
#*# 	0.156645, 0.319880, 0.274851, 0.246750, 0.214490, 0.183877, 0.148208, 0.119079, 0.086537, 0.054397, 0.025562, 0.004886, -0.027952, -0.057935, -0.084701, -0.109246, -0.124350, -0.146576, -0.168964, -0.190812
#*# 	0.147948, 0.321675, 0.285437, 0.260548, 0.227677, 0.198213, 0.169542, 0.140434, 0.101914, 0.068577, 0.037045, 0.012830, -0.019822, -0.051161, -0.084558, -0.114833, -0.137677, -0.164804, -0.190812, -0.207673
#*# 	0.148984, 0.320377, 0.280286, 0.247160, 0.214738, 0.179577, 0.147948, 0.117514, 0.084393, 0.048315, 0.019879, -0.004390, -0.035657, -0.067934, -0.095176, -0.121033, -0.140231, -0.164804, -0.190812, -0.221377
#*# 	0.154114, 0.334722, 0.296310, 0.267700, 0.236480, 0.205065, 0.178430, 0.147948, 0.110559, 0.072146, 0.040901, 0.012830, -0.020247, -0.058580, -0.084701, -0.117018, -0.145367, -0.176807, -0.207746, -0.224459
#*# 	0.168682, 0.342075, 0.296598, 0.266842, 0.228239, 0.198213, 0.162952, 0.134211, 0.101812, 0.065408, 0.033486, 0.006221, -0.027656, -0.059548, -0.091414, -0.117408, -0.140021, -0.164804, -0.199479, -0.230193
#*# 	0.169542, 0.358818, 0.323070, 0.295166, 0.260548, 0.227677, 0.202050, 0.169542, 0.133564, 0.097121, 0.063570, 0.031261, -0.003950, -0.042437, -0.076321, -0.110689, -0.139684, -0.173471, -0.204405, -0.223208
#*# 	0.185255, 0.365870, 0.325879, 0.289731, 0.253516, 0.220475, 0.191045, 0.156314, 0.127022, 0.088373, 0.056212, 0.027150, -0.004619, -0.041880, -0.071960, -0.105847, -0.130913, -0.156798, -0.190119, -0.221115
#*# 	0.194078, 0.387126, 0.354635, 0.322602, 0.287155, 0.249212, 0.223148, 0.191045, 0.152952, 0.116338, 0.078880, 0.047722, 0.012639, -0.027952, -0.059548, -0.100474, -0.132043, -0.166804, -0.199479, -0.218571
#*# 	0.205065, 0.391123, 0.354473, 0.321310, 0.282002, 0.246964, 0.212855, 0.179742, 0.145331, 0.108517, 0.071228, 0.040901, 0.007556, -0.027952, -0.059548, -0.090695, -0.122932, -0.148452, -0.182144, -0.219624
#*# 	0.213321, 0.414205, 0.384626, 0.355088, 0.317047, 0.274851, 0.241670, 0.208778, 0.173269, 0.134706, 0.099698, 0.062040, 0.026071, -0.012316, -0.049661, -0.089772, -0.121227, -0.156131, -0.190812, -0.209576
#*# 	0.222333, 0.424828, 0.389204, 0.357484, 0.321686, 0.282002, 0.246809, 0.210178, 0.174780, 0.138010, 0.104981, 0.071228, 0.033486, -0.003030, -0.035657, -0.069547, -0.100837, -0.131728, -0.164137, -0.201908
#*# 	0.235848, 0.440228, 0.408152, 0.380627, 0.342693, 0.302935, 0.267414, 0.231748, 0.195732, 0.155211, 0.119504, 0.084699, 0.043570, 0.002663, -0.035041, -0.076321, -0.114833, -0.149453, -0.182837, -0.207128
#*# 	0.242783, 0.455154, 0.418278, 0.387126, 0.349445, 0.310477, 0.267700, 0.234308, 0.197662, 0.156038, 0.120989, 0.086537, 0.048315, 0.009526, -0.025178, -0.061806, -0.095753, -0.124132, -0.156825, -0.199479
#*# 	0.254217, 0.475949, 0.438003, 0.406314, 0.371790, 0.330990, 0.290534, 0.253707, 0.216879, 0.176710, 0.140746, 0.105000, 0.063570, 0.020118, -0.020247, -0.064064, -0.100342, -0.133637, -0.164804, -0.190812
#*# 	0.274851, 0.492263, 0.455154, 0.421805, 0.385826, 0.346907, 0.304380, 0.264949, 0.224004, 0.184980, 0.152080, 0.120688, 0.078880, 0.034927, 0.000481, -0.035657, -0.067934, -0.100342, -0.132127, -0.173138
#*# 	0.294594, 0.519971, 0.486193, 0.448993, 0.415131, 0.374628, 0.335012, 0.296310, 0.254155, 0.214855, 0.180724, 0.145823, 0.104010, 0.059744, 0.019991, -0.020247, -0.058542, -0.094935, -0.124350, -0.147203
#*# 	0.333499, 0.541795, 0.509087, 0.480251, 0.438854, 0.400111, 0.358929, 0.318798, 0.274851, 0.235963, 0.200585, 0.169542, 0.127022, 0.086537, 0.048315, 0.008106, -0.020247, -0.050537, -0.084701, -0.121562
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 0.0
#*# max_x = 184.87
#*# min_y = 20.0
#*# max_y = 214.94
